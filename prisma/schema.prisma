generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// User roles: student, mentor, business
enum UserRole {
  student
  mentor
  business
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean?
  image         String?
  role          UserRole  @default(student)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth Relations
  sessions Session[]
  accounts Account[]

  // Profile Relations (Table-per-Role)
  studentProfile  StudentProfile?
  mentorProfile   MentorProfile?
  businessProfile BusinessProfile?

  // Interactions
  reviewsWritten   Review[]          @relation("ReviewsWritten")
  receivedRequests OutreachRequest[] @relation("ReceivedRequests")

  @@map("user")
}

// --- PROFILE TABLES ---

enum StudentAccountType {
  individual
  team
}

model StudentProfile {
  id          String             @id @default(cuid())
  userId      String             @unique
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        StudentAccountType @default(individual)
  bio         String?
  mentorName  String?
  mentorEmail String?
  
  // Team info (for collaborative students)
  teamName    String?
  teamMembers String? 

  // Additional fields from requirements
  participatedWhere String? // Where they participated before
  
  projects    Project[]
  applications Application[]
  outreachRequests OutreachRequest[]

  @@map("student_profile")
}

model MentorProfile {
  id           String  @id @default(cuid())
  userId       String  @unique
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  hasTeams     Boolean @default(false)
  managedTeams String? // Name/Email of teams managed
  bio          String?
  expertise    String?

  competitions Competition[] @relation("MentorCompetitions")
  
  @@map("mentor_profile")
}

enum BusinessAccountType {
  individual
  organization
}

model BusinessProfile {
  id           String              @id @default(cuid())
  userId       String              @unique
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         BusinessAccountType @default(individual)
  companyName  String?
  bio          String?
  interests    String?
  
  investments  Investment[]

  @@map("business_profile")
}

// --- DOMAIN MODELS ---

model Project {
  id               String   @id @default(cuid())
  ownerId          String
  owner            StudentProfile @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  title            String
  description      String
  shortDescription String?
  stage            String   // Idea, MVP, Scaling, etc.
  
  // New detailed fields
  pitchDeckUrl     String?
  pitchVideoUrl    String?
  githubUrl        String?
  
  hasMentor        Boolean  @default(false)
  mentorName       String?
  
  hasInvestors     Boolean  @default(false)
  investedAmount   Float    @default(0)
  
  previousEvents   String?  // Where they participated
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  reviews          Review[]
  applications     Application[]
  investments      Investment[]
  outreachRequests OutreachRequest[]

  @@map("project")
}

model Competition {
  id               String   @id @default(cuid())
  title            String
  description      String
  rules            String?  // Detailed rules/document content
  awards           String?  // Prizes info
  deadline         DateTime
  registrationEnd  DateTime? 
  eventDate        DateTime? // For olympiads
  
  type             String   @default("startup") // startup, olympiad
  
  files            String?  // URLs or file paths
  creatorId        String
  creator          MentorProfile @relation("MentorCompetitions", fields: [creatorId], references: [id])
  createdAt        DateTime @default(now())
  
  applications     Application[]

  @@map("competition")
}


model Application {
  id            String   @id @default(cuid())
  projectId     String?  // Optional for Olympiads if team/project not required
  project       Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  competitionId String?
  competition   Competition? @relation(fields: [competitionId], references: [id])
  
  // Submission details
  type          String   @default("startup") // startup, personal
  category      String?  // For Olympiads
  phone         String
  email         String
  name          String?  // For personal registration
  githubUrl     String?
  docsUrl       String?
  subject       String?  // For Olympiads
  status        String   @default("pending") // pending, approved, rejected
  
  studentId     String
  student       StudentProfile @relation(fields: [studentId], references: [id])
  
  createdAt     DateTime @default(now())

  @@map("application")
}


model Review {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("ReviewsWritten", fields: [authorId], references: [id])
  content   String
  rating    Int
  createdAt DateTime @default(now())

  @@map("review")
}

model Investment {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  investorId  String
  investor    BusinessProfile @relation(fields: [investorId], references: [id])
  amount      Float?
  status      String   @default("interested") // interested, committed, completed
  message     String?
  createdAt   DateTime @default(now())

  @@map("investment")
}

model OutreachRequest {
  id          String   @id @default(cuid())
  senderId    String
  sender      StudentProfile @relation(fields: [senderId], references: [id])
  receiverId  String
  // receiver is a User (Mentor or Business)
  receiver    User @relation("ReceivedRequests", fields: [receiverId], references: [id])
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  message     String
  status      String   @default("sent") // sent, viewed, accepted, rejected
  type        String   // mentor, investor
  createdAt   DateTime @default(now())

  @@map("outreach_request")
}


// --- BETTER AUTH INTERNAL TABLES ---

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}
